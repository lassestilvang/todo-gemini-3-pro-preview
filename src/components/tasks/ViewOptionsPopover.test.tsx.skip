import { describe, it, expect, mock, spyOn, afterEach, beforeEach } from "bun:test";
import { render, screen, cleanup, fireEvent, waitFor } from "@testing-library/react";
import { ViewOptionsPopover } from "./ViewOptionsPopover";
import React from "react";
import * as labelsActions from "@/lib/actions/labels";
import * as viewSettingsActions from "@/lib/actions/view-settings";
import * as viewsActions from "@/lib/actions/views";

beforeEach(() => {
    spyOn(labelsActions, "getLabels").mockResolvedValue([]);
    spyOn(viewSettingsActions, "saveViewSettings").mockResolvedValue({ success: true } as any);
    spyOn(viewSettingsActions, "resetViewSettings").mockResolvedValue({ success: true } as any);
    spyOn(viewsActions, "createSavedView").mockResolvedValue({ success: true, data: { id: 1 } } as any);
});

describe("ViewOptionsPopover", () => {
    afterEach(() => {
        mock.restore();
        cleanup();
    });

    const defaultProps = {
        viewId: "test-view",
        userId: "user-123",
        settings: {
            layout: "list",
            showCompleted: true,
            groupBy: "none",
            sortBy: "manual",
            sortOrder: "asc",
            filterDate: "all",
        },
        onSettingsChange: mock(() => {}),
    };

    it("renders the trigger button", async () => {
        render(<ViewOptionsPopover {...defaultProps} />);
        expect(screen.getByRole("button", { name: /view/i })).toBeDefined();
    });

    it("opens popover and shows layout options with correct aria roles", async () => {
        render(<ViewOptionsPopover {...defaultProps} />);
        const trigger = screen.getByRole("button", { name: /view/i });
        fireEvent.click(trigger);

        await waitFor(() => {
            expect(screen.getByRole("radiogroup", { name: /layout view/i })).toBeDefined();
        });

        const listLayout = screen.getByRole("radio", { name: /list layout/i });
        expect(listLayout).toBeDefined();
        expect(listLayout.getAttribute("aria-checked")).toBe("true");

        const boardLayout = screen.getByRole("radio", { name: /board layout/i });
        expect(boardLayout).toBeDefined();
        expect(boardLayout.getAttribute("aria-checked")).toBe("false");
        // Check disabled state
        expect(boardLayout.hasAttribute("disabled")).toBe(true);
    });

    it("shows sort and filter sections with aria-expanded", async () => {
        render(<ViewOptionsPopover {...defaultProps} />);
        const trigger = screen.getByRole("button", { name: /view/i });
        fireEvent.click(trigger);

        await waitFor(() => {
             expect(screen.getByText("Sort")).toBeDefined();
             expect(screen.getByText("Filter")).toBeDefined();
        });

        const sortToggle = screen.getByText("Sort").closest("button");
        expect(sortToggle).toBeDefined();
        expect(sortToggle?.getAttribute("aria-expanded")).toBe("true");
        expect(sortToggle?.getAttribute("aria-controls")).toBe("sort-options");

        const filterToggle = screen.getByText("Filter").closest("button");
        expect(filterToggle).toBeDefined();
        expect(filterToggle?.getAttribute("aria-expanded")).toBe("true");
        expect(filterToggle?.getAttribute("aria-controls")).toBe("filter-options");
    });

    it("renders save view input with aria-label", async () => {
        render(<ViewOptionsPopover {...defaultProps} />);
        const trigger = screen.getByRole("button", { name: /view/i });
        fireEvent.click(trigger);

        await waitFor(() => {
            expect(screen.getByLabelText("View name")).toBeDefined();
        });

        const input = screen.getByLabelText("View name");
        expect(input).toBeDefined();
    });
});
